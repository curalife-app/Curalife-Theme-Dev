manualJoin:
  params: [listToJoin, separator]
  steps:
    - init:
        assign:
          - joinedString: ""
          - first: true
    - iterate:
        for:
          value: item
          in: ${listToJoin}
          steps:
            - appendItem:
                switch:
                  - condition: ${first}
                    assign:
                      - joinedString: ${item}
                      - first: false
                  - condition: true
                    assign:
                      - joinedString: ${joinedString + separator + item}
    - returnJoinedString:
        return: ${joinedString}

# ==================================================================
#  User Creation Workflow (Shopify & HubSpot) - HIPAA Compliant
# ==================================================================

main:
  params: [request]

  steps:
    # ---------------------------------------------------------------
    # 0. Load configuration & CORS headers
    # ---------------------------------------------------------------
    - setup:
        assign:
          - corsHeaders:
              Access-Control-Allow-Origin: "*"
              Access-Control-Allow-Methods: "POST, GET, OPTIONS"
              Access-Control-Allow-Headers: "Content-Type, Authorization, X-Requested-With"
              Access-Control-Allow-Credentials: "true"
              Access-Control-Max-Age: "3600"
              Content-Type: "application/json"
          - rawData: ${request} # Use the entire request object
          - parsedData: null
          - actualPayload: null
          - hubspotBaseUrl: "https://api.hubapi.com"
          - shopifyStoreName: ${if(sys.get_env("SHOPIFY_STORE_NAME") != null, sys.get_env("SHOPIFY_STORE_NAME"), "curalife-commerce")}
          - shopifyGraphQLUrl: ${"https://" + shopifyStoreName + ".myshopify.com/admin/api/2025-04/graphql.json"}
          - shopifySearchUrl: ${"https://" + shopifyStoreName + ".myshopify.com/admin/api/2025-04/customers/search.json"}
          - hubspotAccessToken: ${if(sys.get_env("HUBSPOT_ACCESS_TOKEN") != null, sys.get_env("HUBSPOT_ACCESS_TOKEN"), "")}
          - shopifyAdminToken: ${if(sys.get_env("SHOPIFY_ADMIN_TOKEN") != null, sys.get_env("SHOPIFY_ADMIN_TOKEN"), "")}
          - timestamp: ${sys.now()}
          # Eligibility workflow endpoint for server-side calls
          - eligibilityWorkflowUrl: "https://us-central1-telemedicine-458913.cloudfunctions.net/workflow_eligibility"

    # ---------------------------------------------------------------
    # 1.  Validate tokens
    # ---------------------------------------------------------------
    - validateTokens:
        switch:
          - condition: ${hubspotAccessToken == ""}
            return:
              statusCode: 500
              headers: ${corsHeaders}
              body:
                success: false
                error: "Missing HUBSPOT_ACCESS_TOKEN environment variable"
                timestamp: ${timestamp}
          - condition: ${shopifyAdminToken == ""}
            return:
              statusCode: 500
              headers: ${corsHeaders}
              body:
                success: false
                error: "Missing SHOPIFY_ADMIN_TOKEN environment variable"
                timestamp: ${timestamp}
          - condition: true
            next: parseJson

    # ---------------------------------------------------------------
    # 2.  Parse JSON payload
    # ---------------------------------------------------------------
    - parseJson:
        assign:
          # rawData is already parsed by Workflows, no need to decode
          - parsedData: ${rawData}

    # ---------------------------------------------------------------
    # 3.  If payload has nested "data" field â†’ parse again
    # ---------------------------------------------------------------
    - resolveDataField:
        switch:
          - condition: ${parsedData != null and "data" in parsedData}
            try:
              assign:
                - actualPayload: ${json.decode(parsedData.data)}
            except:
              assign:
                - actualPayload: ${parsedData.data}
          - condition: true
            assign:
              - actualPayload: ${parsedData}

    # ---------------------------------------------------------------
    # 4.  Init variables (email etc.)
    # ---------------------------------------------------------------
    - initializeVars:
        assign:
          - customerEmail: ""
          - firstName: ""
          - lastName: ""
          - phoneNumber: ""
          - state: ""
          - insurance: ""
          - insuranceMemberId: ""
          - groupNumber: ""
          - mainReasons: []
          - medicalConditions: []
          - dateOfBirth: ""
          - consent: false
          - quizId: ${if(actualPayload != null and "quizId" in actualPayload, actualPayload.quizId, "unknown")}
          - quizTitle: ${if(actualPayload != null and "quizTitle" in actualPayload, actualPayload.quizTitle, "Unknown Quiz")}
          - timestamp: ${if(actualPayload != null and "completedAt" in actualPayload, actualPayload.completedAt, sys.now())}
          - emptyMap: {}
          - emptyArray: []
          - responses: ${if(actualPayload != null and "allResponses" in actualPayload, actualPayload.allResponses, emptyArray)}
          # Initialize eligibility data containers
          - eligibilityDataRaw: ${emptyMap}
          - eligibilityData: ${emptyMap}
          - stediResponse: null

    # ---------------------------------------------------------------
    # 5.  Extract values directly from the payload
    # ---------------------------------------------------------------
    - extractFields:
        assign:
          - customerEmail: ${if(actualPayload != null and "customerEmail" in actualPayload, actualPayload.customerEmail, "")}
          - firstName: ${if(actualPayload != null and "firstName" in actualPayload, actualPayload.firstName, "")}
          - lastName: ${if(actualPayload != null and "lastName" in actualPayload, actualPayload.lastName, "")}
          - phoneNumber: ${if(actualPayload != null and "phoneNumber" in actualPayload, actualPayload.phoneNumber, "")}
          - state: ${if(actualPayload != null and "state" in actualPayload, actualPayload.state, "")}
          - insurance: ${if(actualPayload != null and "insurance" in actualPayload, actualPayload.insurance, "")}
          - insuranceMemberId: ${if(actualPayload != null and "insuranceMemberId" in actualPayload, actualPayload.insuranceMemberId, "")}
          - groupNumber: ${if(actualPayload != null and "groupNumber" in actualPayload, actualPayload.groupNumber, "")}
          - dateOfBirth: ${if(actualPayload != null and "dateOfBirth" in actualPayload, actualPayload.dateOfBirth, "")}
          - consent: ${if(actualPayload != null and "consent" in actualPayload, actualPayload.consent, false)}
          - testMode: ${if(actualPayload != null and "testMode" in actualPayload, actualPayload.testMode, false)}

    # ---------------------------------------------------------------
    # 5a. Parse mainReasons and medicalConditions
    # ---------------------------------------------------------------
    - parseMainReasons:
        assign:
          - _mr_raw: ${if(actualPayload != null and "mainReasons" in actualPayload, actualPayload.mainReasons, null)}

    - processMainReasons:
        switch:
          - condition: ${_mr_raw == null}
            assign:
              - reasonsText: ""
              - mainReasons: []
          - condition: true
            try:
              # Try to use as array first
              call: manualJoin
              args:
                listToJoin: ${_mr_raw}
                separator: ", "
              result: reasonsText
            except:
              # If it fails, it's a string
              assign:
                - reasonsText: ${_mr_raw}
                - mainReasons:
                    - ${_mr_raw}
            next: setMainReasonsArray

    - setMainReasonsArray:
        assign:
          - mainReasons: ${_mr_raw}
        next: parseMedicalConditions

    - parseMedicalConditions:
        assign:
          - _mc_raw: ${if(actualPayload != null and "medicalConditions" in actualPayload, actualPayload.medicalConditions, null)}

    - processMedicalConditions:
        switch:
          - condition: ${_mc_raw == null}
            assign:
              - conditionsText: ""
              - medicalConditions: []
          - condition: true
            try:
              # Try to use as array first
              call: manualJoin
              args:
                listToJoin: ${_mc_raw}
                separator: ", "
              result: conditionsText
            except:
              # If it fails, it's a string
              assign:
                - conditionsText: ${_mc_raw}
                - medicalConditions:
                    - ${_mc_raw}
            next: setMedicalConditionsArray

    - setMedicalConditionsArray:
        assign:
          - medicalConditions: ${_mc_raw}
        next: validateEmail

    # ---------------------------------------------------------------
    # 6. Validate email and insurance info
    # ---------------------------------------------------------------
    - validateEmail:
        switch:
          - condition: ${customerEmail != ""}
            next: checkInsuranceEligibility
          - condition: true
            return:
              statusCode: 400
              headers: ${corsHeaders}
              body:
                status: "skipped"
                success: false
                reason: "Invalid email address"
                attemptedEmail: ${customerEmail}

    # ---------------------------------------------------------------
    # 7. Check insurance eligibility server-side (HIPAA compliant)
    # ---------------------------------------------------------------
    - checkInsuranceEligibility:
        switch:
          # Only check eligibility if we have insurance information
          - condition: ${insurance != "" and insuranceMemberId != "" and firstName != "" and lastName != ""}
            next: callEligibilityWorkflow
          - condition: true
            # Skip eligibility check if insurance info is missing
            assign:
              - eligibilityData:
                  isEligible: false
                  sessionsCovered: 0
                  deductible: { individual: 0 }
                  eligibilityStatus: "NO_INSURANCE_INFO"
                  userMessage: "Insurance information not provided"
                  planBegin: ""
                  planEnd: ""
              - eligibilityDataRaw: ${eligibilityData}
            next: tryCreateShopifyCustomer

    - callEligibilityWorkflow:
        try:
          call: http.post
          args:
            url: ${eligibilityWorkflowUrl}
            headers:
              Content-Type: "application/json"
              X-Workflow-Type: "eligibility"
            body:
              firstName: ${firstName}
              lastName: ${lastName}
              insurance: ${insurance}
              insuranceMemberId: ${insuranceMemberId}
              groupNumber: ${groupNumber}
              dateOfBirth: ${dateOfBirth}
              testMode: ${testMode}
          result: eligibilityResponse
        except:
          as: e
          assign:
            - eligibilityResponse: ${e}
        next: processEligibilityResponse

    - processEligibilityResponse:
        switch:
          - condition: ${eligibilityResponse.code >= 200 and eligibilityResponse.code < 300 and "body" in eligibilityResponse and "success" in eligibilityResponse.body and eligibilityResponse.body.success}
            assign:
              - eligibilityDataRaw: ${eligibilityResponse.body.eligibilityData}
              - stediResponse: ${if("debug" in eligibilityResponse.body, eligibilityResponse.body.debug, null)}
              # Extract safe fields for contact creation
              - eligibilityData:
                  isEligible: ${eligibilityDataRaw.isEligible}
                  sessionsCovered: ${eligibilityDataRaw.sessionsCovered}
                  deductible: ${eligibilityDataRaw.deductible}
                  eligibilityStatus: ${eligibilityDataRaw.eligibilityStatus}
                  userMessage: ${eligibilityDataRaw.userMessage}
                  planBegin: ${eligibilityDataRaw.planBegin}
                  planEnd: ${eligibilityDataRaw.planEnd}
            next: tryCreateShopifyCustomer
          - condition: true
            # Eligibility check failed, but continue with user creation
            assign:
              - eligibilityData:
                  isEligible: false
                  sessionsCovered: 0
                  deductible: { individual: 0 }
                  eligibilityStatus: "ELIGIBILITY_CHECK_FAILED"
                  userMessage: "Unable to verify insurance eligibility at this time"
                  planBegin: ""
                  planEnd: ""
              - eligibilityDataRaw: ${eligibilityData}
            next: tryCreateShopifyCustomer

    # ---------------------------------------------------------------
    # 8. Create Shopify customer
    # ---------------------------------------------------------------
    - tryCreateShopifyCustomer:
        try:
          call: http.post
          args:
            url: ${shopifyGraphQLUrl}
            headers:
              X-Shopify-Access-Token: ${shopifyAdminToken}
              Content-Type: "application/json"
              Accept: "application/json"
            body:
              query: "mutation customerCreateMutation($input: CustomerInput!) { customerCreate(input: $input) { customer { id } userErrors { field message } } }"
              variables:
                input:
                  email: ${customerEmail}
                  firstName: ${firstName}
                  lastName: ${lastName}
                  phone: ${phoneNumber}
          result: shopifyCustomerResponse
        except:
          as: e
          steps:
            - assignErrorToResponse:
                assign:
                  - shopifyCustomerResponse: ${e}
        next: logShopifyResponse

    - logShopifyResponse:
        call: sys.log
        args:
          data: ${shopifyCustomerResponse}
          severity: INFO
        next: checkShopifyResponse

    - checkShopifyResponse:
        assign:
          - shopifyResponseCode: ${shopifyCustomerResponse.code}
          - shopifyHasBody: ${"body" in shopifyCustomerResponse}
          - shopifyHasData: ${shopifyHasBody and "data" in shopifyCustomerResponse.body}
          - shopifyHasCustomerCreate: ${shopifyHasData and "customerCreate" in shopifyCustomerResponse.body.data}
          - shopifyHasUserErrors: ${shopifyHasCustomerCreate and "userErrors" in shopifyCustomerResponse.body.data.customerCreate and len(shopifyCustomerResponse.body.data.customerCreate.userErrors) > 0}
          - shopifyHasCustomer: ${shopifyHasCustomerCreate and "customer" in shopifyCustomerResponse.body.data.customerCreate and shopifyCustomerResponse.body.data.customerCreate.customer != null}
          - shopifyEmailTakenError: false
          - shopifyPhoneTakenError: false
        next: checkGraphQLUserErrors

    - checkGraphQLUserErrors:
        switch:
          - condition: ${shopifyHasUserErrors}
            assign:
              - userErrors: ${shopifyCustomerResponse.body.data.customerCreate.userErrors}
              - shopifyEmailTakenError: true
              - shopifyPhoneTakenError: true
            next: handleShopifyCustomerResp
          - condition: true
            next: handleShopifyCustomerResp

    - handleShopifyCustomerResp:
        switch:
          # Case 1: Successful GraphQL customer creation
          - condition: ${shopifyResponseCode >= 200 and shopifyResponseCode < 300 and shopifyHasCustomer}
            assign:
              - shopifyCustomerId: ${shopifyCustomerResponse.body.data.customerCreate.customer.id}
            next: createHubSpotContact

          # Case 2: GraphQL customer already exists (userErrors with "taken" messages)
          - condition: >-
              ${shopifyResponseCode >= 200 and shopifyResponseCode < 300 and shopifyHasUserErrors and (
                shopifyEmailTakenError or
                shopifyPhoneTakenError
              )}
            next: searchExistingShopifyCustomer

          # Case 3: Other GraphQL userErrors (validation errors)
          - condition: ${shopifyResponseCode >= 200 and shopifyResponseCode < 300 and shopifyHasUserErrors}
            assign:
              - shopifyError: "Shopify validation errors occurred. Phone or email may be invalid."
            next: shopifyErrorGeneral

          # Case 4: GraphQL errors in response
          - condition: ${shopifyHasBody and "errors" in shopifyCustomerResponse.body}
            assign:
              - shopifyError: "GraphQL Error: See workflow logs for details"
            next: shopifyErrorGeneral

          # Case 5: Fallback for other errors
          - condition: true
            assign:
              - shopifyError: "Call failed with unknown status"
            next: shopifyErrorGeneral

    - searchExistingShopifyCustomer:
        call: http.post
        args:
          url: ${shopifyGraphQLUrl}
          headers:
            X-Shopify-Access-Token: ${shopifyAdminToken}
            Content-Type: "application/json"
            Accept: "application/json"
          body:
            query: "query customerSearchQuery($query: String!) { customers(first: 1, query: $query) { edges { node { id } } } }"
            variables:
              query: ${"email:" + customerEmail}
        result: shopifySearchResponse

    - handleShopifySearchResponse:
        switch:
          - condition: ${shopifySearchResponse.code >= 200 and shopifySearchResponse.code < 300 and "body" in shopifySearchResponse and "data" in shopifySearchResponse.body and "customers" in shopifySearchResponse.body.data and "edges" in shopifySearchResponse.body.data.customers and len(shopifySearchResponse.body.data.customers.edges) > 0}
            assign:
              - shopifyCustomerId: ${shopifySearchResponse.body.data.customers.edges[0].node.id}
            next: createHubSpotContact
          - condition: true
            assign:
              - shopifyCustomerId: null
              - shopifySearchError: "Shopify customer search failed"
            next: createHubSpotContact

    # ---------------------------------------------------------------
    # 9. Create HubSpot Contact
    # ---------------------------------------------------------------
    - createHubSpotContact:
        try:
          call: http.post
          args:
            url: ${hubspotBaseUrl + "/crm/v3/objects/contacts"}
            headers:
              Authorization: '${"Bearer " + hubspotAccessToken}'
              Content-Type: "application/json"
            body:
              properties:
                # Standard HubSpot fields
                email: ${customerEmail}
                firstname: ${firstName}
                lastname: ${lastName}
                phone: ${phoneNumber}
                # Custom fields that exist in your HubSpot account
                registration_date: ${text.split(timestamp, "T")[0]} # Convert to YYYY-MM-DD format
                date_of_birth: ${dateOfBirth}
                shopify_customer_id: ${shopifyCustomerId}
                email_subscribed: ${string(consent)}
                sms_subscribed: ${string(consent)}
                has_account: "true"
                # Telemedicine categories (confirmed to exist)
                telemedicine_primary_category: ${reasonsText}
                telemedicine_secondary_category: ${if(conditionsText != "", text.split(conditionsText, ",")[0], "")} # Only send first value for dropdown
          result: hubspotContactResponse
        except:
          as: e
          assign:
            # Create a response object that mimics the successful HTTP response format
            # This allows the existing error handling logic to work properly
            - hubspotContactResponse:
                code: ${e.code}
                body: ${e.body}
                headers: ${if("headers" in e, e.headers, null)}
        next: handleContactResp

    - handleContactResp:
        switch:
          - condition: ${hubspotContactResponse.code >= 200 and hubspotContactResponse.code < 300}
            assign:
              - hubspotContactId: ${hubspotContactResponse.body.id}
            next: createInsurancePlan
          - condition: ${hubspotContactResponse.code == 409}
            next: getExistingContact
          - condition: true
            next: hubspotError

    - getExistingContact:
        call: http.post
        args:
          url: ${hubspotBaseUrl + "/crm/v3/objects/contacts/search"}
          headers: { Authorization: '${"Bearer " + hubspotAccessToken}', Content-Type: "application/json" }
          body:
            filterGroups:
              - filters:
                  - propertyName: "email"
                    operator: "EQ"
                    value: ${customerEmail}
        result: searchResp

    - assignExistingId:
        switch:
          - condition: ${searchResp.code >= 200 and searchResp.code < 300 and "body" in searchResp and "results" in searchResp.body and len(searchResp.body.results) > 0}
            assign:
              - hubspotContactId: ${searchResp.body.results[0].id}
            next: updateExistingContact
          - condition: true
            next: hubspotError

    # Update existing contact with new information
    - updateExistingContact:
        call: http.patch
        args:
          url: ${hubspotBaseUrl + "/crm/v3/objects/contacts/" + hubspotContactId}
          headers:
            Authorization: '${"Bearer " + hubspotAccessToken}'
            Content-Type: "application/json"
          body:
            properties:
              # Standard HubSpot fields
              firstname: ${firstName}
              lastname: ${lastName}
              phone: ${phoneNumber}
              # Custom fields that exist in your HubSpot account
              registration_date: ${text.split(timestamp, "T")[0]} # Convert to YYYY-MM-DD format
              date_of_birth: ${dateOfBirth}
              shopify_customer_id: ${shopifyCustomerId}
              email_subscribed: ${string(consent)}
              sms_subscribed: ${string(consent)}
              has_account: "true"
              # Telemedicine categories (confirmed to exist)
              telemedicine_primary_category: ${reasonsText}
              telemedicine_secondary_category: ${if(conditionsText != "", text.split(conditionsText, ",")[0], "")} # Only send first value for dropdown
        result: updateResp
        next: createInsurancePlan

    # ---------------------------------------------------------------
    # 10. Create Insurance Plan in HubSpot (only if insurance data exists)
    # ---------------------------------------------------------------
    - createInsurancePlan:
        switch:
          # Only create insurance plan if we have insurance information and eligibility data
          - condition: ${insurance != "" and insuranceMemberId != "" and eligibilityDataRaw != null}
            next: callInsurancePlanWorkflow
          - condition: true
            # No insurance information, skip insurance plan creation
            next: returnSuccessNoInsurance

    - callInsurancePlanWorkflow:
        try:
          call: http.post
          args:
            url: ${eligibilityWorkflowUrl}
            headers:
              Content-Type: "application/json"
              X-Workflow-Type: "insurance_plan"
            body:
              # Pass all the original data plus the hubspotContactId
              customerEmail: ${customerEmail}
              firstName: ${firstName}
              lastName: ${lastName}
              phoneNumber: ${phoneNumber}
              state: ${state}
              insurance: ${insurance}
              insuranceMemberId: ${insuranceMemberId}
              groupNumber: ${groupNumber}
              dateOfBirth: ${dateOfBirth}
              hubspotContactId: ${hubspotContactId}
              eligibilityData: ${eligibilityDataRaw}
              stediResponse: ${stediResponse}
              mainReasons: ${mainReasons}
              medicalConditions: ${medicalConditions}
          result: insurancePlanResponse
        except:
          as: e
          assign:
            - insurancePlanResponse: ${e}
        next: handleInsurancePlanResponse

    - handleInsurancePlanResponse:
        switch:
          - condition: ${insurancePlanResponse.code >= 200 and insurancePlanResponse.code < 300}
            assign:
              - insurancePlanSuccess: true
              - insurancePlanId: ${if("body" in insurancePlanResponse and "insurancePlanId" in insurancePlanResponse.body, insurancePlanResponse.body.insurancePlanId, "")}
              - insurancePlanObjectId: ${if("body" in insurancePlanResponse and "insurancePlanObjectId" in insurancePlanResponse.body, insurancePlanResponse.body.insurancePlanObjectId, "")}
            next: returnSuccess
          - condition: true
            # Log the error but continue - don't fail the entire workflow
            call: sys.log
            args:
              data:
                message: "Insurance plan creation failed but continuing"
                error: ${insurancePlanResponse}
              severity: WARNING
            next: returnSuccessWithInsuranceWarning

        # ---------------------------------------------------------------
    # 11. Success responses
    # ---------------------------------------------------------------
    - prepareSuccessResponse:
        assign:
          - responseBody:
              success: true
              quizId: ${quizId}
              customerEmail: ${customerEmail}
              shopifyCustomerId: ${shopifyCustomerId}
              hubspotContactId: ${hubspotContactId}
              timestamp: ${timestamp}
              eligibilityStatus: ${eligibilityData.eligibilityStatus}
              isEligible: ${eligibilityData.isEligible}
              eligibilityMessage: ${eligibilityData.userMessage}
          - eligibilityResponseData:
              eligibilityStatus: ${eligibilityData.eligibilityStatus}
              isEligible: ${eligibilityData.isEligible}
              userMessage: ${eligibilityData.userMessage}
              sessionsCovered: ${if(eligibilityDataRaw != null and "sessionsCovered" in eligibilityDataRaw, eligibilityDataRaw.sessionsCovered, 0)}
              copay: ${if(eligibilityDataRaw != null and "copay" in eligibilityDataRaw, eligibilityDataRaw.copay, 0)}
              planBegin: ${if(eligibilityDataRaw != null and "planBegin" in eligibilityDataRaw, eligibilityDataRaw.planBegin, "")}
              planEnd: ${if(eligibilityDataRaw != null and "planEnd" in eligibilityDataRaw, eligibilityDataRaw.planEnd, "")}
          - insurancePlanInfo:
              success: ${if(insurancePlanSuccess != null, insurancePlanSuccess, false)}
              insurancePlanId: ${if(insurancePlanId != null, insurancePlanId, "")}
              insurancePlanObjectId: ${if(insurancePlanObjectId != null, insurancePlanObjectId, "")}
        next: addDeductibleInfo

    - addDeductibleInfo:
        assign:
          - eligibilityResponseData.deductible: ${if(eligibilityDataRaw != null and "deductible" in eligibilityDataRaw, eligibilityDataRaw.deductible, emptyMap)}
        next: returnSuccess

    - returnSuccess:
        assign:
          - responseBody.eligibilityData: ${eligibilityResponseData}
          - responseBody.insurancePlan: ${insurancePlanInfo}
        next: sendSuccessResponse

    - sendSuccessResponse:
        return:
          statusCode: 200
          headers: ${corsHeaders}
          body: ${responseBody}

    - returnSuccessWithInsuranceWarning:
        assign:
          - warningResponseBody:
              success: true
              quizId: ${quizId}
              customerEmail: ${customerEmail}
              shopifyCustomerId: ${shopifyCustomerId}
              hubspotContactId: ${hubspotContactId}
              timestamp: ${timestamp}
              eligibilityStatus: ${eligibilityData.eligibilityStatus}
              isEligible: ${eligibilityData.isEligible}
              eligibilityMessage: ${eligibilityData.userMessage}
              eligibilityData: ${eligibilityResponseData}
              insurancePlan:
                success: false
                error: "Insurance plan creation failed - see logs"
                insurancePlanId: ""
                insurancePlanObjectId: ""
        next: sendWarningResponse

    - sendWarningResponse:
        return:
          statusCode: 200
          headers: ${corsHeaders}
          body: ${warningResponseBody}

    - returnSuccessNoInsurance:
        assign:
          - noInsuranceResponseBody:
              success: true
              quizId: ${quizId}
              customerEmail: ${customerEmail}
              shopifyCustomerId: ${shopifyCustomerId}
              hubspotContactId: ${hubspotContactId}
              timestamp: ${timestamp}
              eligibilityStatus: "NO_INSURANCE_INFO"
              isEligible: false
              eligibilityMessage: "No insurance information provided"
              eligibilityData:
                eligibilityStatus: "NO_INSURANCE_INFO"
                isEligible: false
                userMessage: "No insurance information provided"
                sessionsCovered: 0
                copay: 0
                planBegin: ""
                planEnd: ""
                deductible: ${emptyMap}
              insurancePlan:
                success: false
                error: "No insurance information provided"
                insurancePlanId: ""
                insurancePlanObjectId: ""
        next: sendNoInsuranceResponse

    - sendNoInsuranceResponse:
        return:
          statusCode: 200
          headers: ${corsHeaders}
          body: ${noInsuranceResponseBody}

    # ---------------------------------------------------------------
    # 12. Error handlers
    # ---------------------------------------------------------------
    - shopifyErrorGeneral:
        return:
          statusCode: 500
          headers: ${corsHeaders}
          body:
            success: false
            error: ${if(shopifyError != null, shopifyError, "Unknown Shopify error")}
            quizId: ${quizId}
            timestamp: ${timestamp}

    - hubspotError:
        return:
          statusCode: 500
          headers: ${corsHeaders}
          body:
            success: false
            error: ${if(hubspotContactResponse.body != null and "message" in hubspotContactResponse.body, hubspotContactResponse.body.message, "Unknown HubSpot error")}
            statusCode: ${if(hubspotContactResponse.code != null, hubspotContactResponse.code, 500)}
            quizId: ${quizId}
            timestamp: ${timestamp}
