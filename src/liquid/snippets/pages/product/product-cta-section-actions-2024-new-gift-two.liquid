{% assign isGlobal = false %}
{% if shop.name contains 'Global' %}
	{% assign isGlobal = true %}
{% endif %}

{% assign variantsAmount = product.variants.size %}

<div class="product-actions">
	<div class="purchase-options md:p-2 flex flex-col gap-2">
		<div class="purchase-type flex-nowrap flex w-full gap-2">
			{% assign subscriptionFeatures = 'Save on every order,Guaranteed delivery,Make changes anytime,VIP support,New subscribers gifs' | split: ',' %}
			<button class="subscription selected flex items-center justify-center gap-2" aria-label="Subscribe & Save">
				<span>
					Subscribe
					<div class="desktop">& Save</div>
					{% render 'tooltip',
						SID: SID,
						linkTitle: '<i class="tooltip-icon fa-duotone fa-circle-info text-[18px]"></i>',
						title: 'Subscription Details',
						description: '',
						features: subscriptionFeatures
					%}
				</span>
			</button>
			<button class="buy-once z-0" aria-label="Buy Once"><span>Buy Once</span></button>
		</div>

		{% for var in product.variants %}
			{% render 'product-cta-section-actions-variant-2024-new', SID: SID, prod: product, var: var, buyBoxColor: buyBoxColor, index: forloop.index %}
		{% endfor %}

		<div class="gift-selector-wrap">
			<div class="gift-selector-title mb-2">Your free gifts:</div>

			<div class="gift-options flex-nowrap flex justify-start gap-4">
				{% for block in blocks %}
					{% case block.type %}
						{% when 'gift' %}
							{% assign show_gift = false %}
							{% if block.settings.show_on == 'both' %}
								{% assign show_gift = true %}
							{% elsif block.settings.show_on == 'global' and isGlobal %}
								{% assign show_gift = true %}
							{% elsif block.settings.show_on == 'us' and isGlobal == false %}
								{% assign show_gift = true %}
							{% endif %}

							{% if show_gift %}
								{% assign giftProd = block.settings.gift_product %}
								{% assign giftVariant = giftProd.selected_or_first_available_variant %}
								{% assign giftProdSubscription = block.settings.gift_product_subscription %}
								{% assign giftVariantSubscription = giftProdSubscription.selected_or_first_available_variant %}
								{% assign giftThumb = block.settings.gift_thumbnail | default: giftProdSubscription.featured_image | default: giftProd.featured_image %}

								<div class="gift-option-container flex flex-col items-center">
									<div
										class="gift-option-border relative w-full p-2 mb-3 border rounded-lg cursor-pointer"
										data-gift-id="{{ giftVariant.id }}"
										data-gift-id-subscription="{{ giftVariantSubscription.id }}">
										<div class="radio-indicator top-2 right-2 absolute flex items-center justify-center w-6 h-6 rounded-full">
											<div class="check-mark hidden w-4 h-4 font-bold text-white rounded-full">✓</div>
										</div>
										<div class="gift-image-container flex justify-center">
											<img
												src="{{ giftThumb | image_url }}"
												alt="{{ giftProd.title }}"
												class="object-contain w-24 h-24">
										</div>
									</div>
									<div class="gift-content text-center">
										<div class="gift-name mb-1 font-medium">{{ giftProd.title | replace: 'Free ', '' }}</div>
										<div class="gift-price flex items-center justify-center gap-2">
											<span class="original-price text-gray-500 line-through">
												{{- giftVariantSubscription.compare_at_price | money_with_currency -}}
											</span>
											<span class="sale-price font-bold">FREE</span>
										</div>
									</div>
								</div>
							{% endif %}
					{% endcase %}
				{% endfor %}
			</div>
		</div>

		<div class="submit-wrap flex flex-col w-full">
			<div class="checkout-button">
				{% if shop.name == 'CuraLife Global' %}
					{% assign isGlobal = true %}
				{% endif %}

				<div>
					<input
						class="submit-variant-id"
						type="hidden"
						name="id"
						value="{{ variant | default: product.selected_or_first_available_variant.id }}"
						class="product-variant-id">
					<input class="submit-selling-plan-id" type="hidden" name="selling_plan" value="{{ selling_plan_id }}">

					<div class="product-form__buttons main-submit-wrapper flex">
						<button
							id="ProductSubmitButton-{{SID}}"
							data-variant-id="{{ variant | default: product.selected_or_first_available_variant.id }}"
							type="button"
							name="add"
							class="text-black w-full product-form__submit button--full-width justify-center button--primary text-[20px] p-0 min-h-[50px] items-center bg-orange">
							<span class="submit-title">
								{% if buyType == 'buy_now' %}
									Buy Now
								{% else %}
									Add To Cart
								{% endif %}
							</span>
							<div class="loading-overlay__spinner hidden">
								<svg
									aria-hidden="true"
									focusable="false"
									class="spinner"
									viewBox="0 0 66 66"
									xmlns="http://www.w3.org/2000/svg">
									<circle class="path !stroke-white" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
								</svg>
							</div>
						</button>
					</div>

					<div
						class="product-form__error-message-wrapper bg-light-red p-2 mt-1 text-center rounded-sm"
						role="alert"
						hidden>
						<div class="error-wrapper flex items-center justify-center">
							<svg aria-hidden="true" focusable="false" class="icon icon-error h-[20px] mr-1" viewBox="0 0 13 13">
								<circle cx="6.5" cy="6.50049" r="5.5" stroke="white" stroke-width="2"/>
								<circle cx="6.5" cy="6.5" r="5.5" fill="#EB001B" stroke="#EB001B" stroke-width="0.7"/>
								<path d="M5.87413 3.52832L5.97439 7.57216H7.02713L7.12739 3.52832H5.87413ZM6.50076 9.66091C6.88091 9.66091 7.18169 9.37267 7.18169 9.00504C7.18169 8.63742 6.88091 8.34917 6.50076 8.34917C6.12061 8.34917 5.81982 8.63742 5.81982 9.00504C5.81982 9.37267 6.12061 9.66091 6.50076 9.66091Z" fill="white"/>
								<path d="M5.87413 3.17832H5.51535L5.52424 3.537L5.6245 7.58083L5.63296 7.92216H5.97439H7.02713H7.36856L7.37702 7.58083L7.47728 3.537L7.48617 3.17832H7.12739H5.87413ZM6.50076 10.0109C7.06121 10.0109 7.5317 9.57872 7.5317 9.00504C7.5317 8.43137 7.06121 7.99918 6.50076 7.99918C5.94031 7.99918 5.46982 8.43137 5.46982 9.00504C5.46982 9.57872 6.12061 10.0109 6.50076 10.0109Z" fill="white" stroke="#EB001B" stroke-width="0.7">
							</svg>
							<span class="product-form__error-message text-[12px]"></span>
						</div>

						<div class="notice">
							Please
							<a class="underline" href="https://help{% if isGlobal %}-global{% endif %}.curalife.com/">Contact Us</a>
							, we'd love to help!
						</div>
					</div>
					{% comment %} </product-form> {% endcomment %}
				</div>

				{% if isBuyWithPrime and isGlobal != true and customer.b2b? == false %}
					<div class="bwp-button">
						{% render 'buy-with-prime-button' %}
					</div>
				{% endif %}

				{% if customer %}
					{% render 'yotpo-product-points-widget' %}
				{% endif %}
			</div>
		</div>
	</div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const productActions = document.querySelector('#cta-section-{{ SID }} .product-actions');
    const SID = '{{ SID }}';
    window.SID = SID;

    const purchaseOptionBoxes = productActions.querySelectorAll('.purchase-option-box');
		const currentProductId = {{ product.id }};

    const styleSheet = document.createElement("style");
    styleSheet.textContent = `
      .subscription-content, .buy-once-content {
        transition: opacity 0.3s ease-in-out;
      }
    `;
    document.head.appendChild(styleSheet);

    initializePurchaseOptions();
    setupMutationObserver();

		{% assign giftProductIds = '' %}
		{% for block in blocks %}
			{% case block.type %}
				{% when 'gift' %}
					{% assign giftProd = block.settings.gift_product %}
					{% assign giftProdSubscription = block.settings.gift_product_subscription %}
					{% assign giftProductIds = giftProductIds | append: giftProd.id | append: ',' %}
					{% assign giftProductIds = giftProductIds | append: giftProdSubscription.id | append: ',' %}
			{% endcase %}
		{% endfor %}

		const giftProductIds = '{{ giftProductIds | strip }}'.split(',').filter(id => id);

		// Build a mapping of gift variant IDs to product IDs
		const giftVariantToProductIdMap = {
			{% for block in blocks %}
				{% case block.type %}
					{% when 'gift' %}
						{% assign giftProd = block.settings.gift_product %}
						{% assign giftProdSubscription = block.settings.gift_product_subscription %}
						'{{ giftProd.selected_or_first_available_variant.id }}': {{ giftProd.id }},
						'{{ giftProdSubscription.selected_or_first_available_variant.id }}': {{ giftProdSubscription.id }},
					{% endcase %}
				{% endfor %}
			};

			function getProductIdByVariantId(variantId) {
  return giftVariantToProductIdMap[variantId] || null;
}

		const MAX_GIFTS = 2;
		let selectedGifts = [];
		const giftOptionContainers = document.querySelectorAll('.gift-option-container');

		// giftOptionContainers.forEach(container => {
		// 	container.addEventListener('click', function(event) {
		// 		const isSelected = selectedGifts.includes(container);

		// 		if (isSelected) {
		// 			// If already selected, deselect it
		// 			selectedGifts = selectedGifts.filter(gift => gift !== container);
		// 		} else if (selectedGifts.length < MAX_GIFTS) {
		// 			// If not selected and we haven't reached max gifts, select it
		// 			selectedGifts.push(container);
		// 		} else if (selectedGifts.length === MAX_GIFTS) {
		// 			// If we're at max gifts, shift out the first one and add the new one
		// 			const oldestGift = selectedGifts.shift();
		// 			selectedGifts.push(container);
		// 		}

		// 		updateRadioIndicators();
		// 	});
		// });

    function updateRadioIndicators() {
			giftOptionContainers.forEach(container => {
				const checkMark = container.querySelector('.check-mark');
				if (selectedGifts.includes(container)) {
					checkMark.classList.remove('hidden');
					container.classList.add('selected');
				} else {
					checkMark.classList.add('hidden');
					container.classList.remove('selected');
				}
			});
		}

    if (giftOptionContainers.length > 0) {
      const giftsToSelect = Math.min(2, giftOptionContainers.length);
      for(let i = 0; i < giftsToSelect; i++) {
        const gift = giftOptionContainers[i];
        gift.classList.add('selected');
        selectedGifts.push(gift);
      }
      updateRadioIndicators();
    }

    function isSubscriptionSelected() {
			const productActions = document.querySelector('.product-actions');
			const selectedButton = productActions?.querySelector('.purchase-type button.selected');
			return selectedButton?.classList.contains('subscription') ?? true;
		}

    function initializePurchaseOptions() {
      const urlParams = new URLSearchParams(window.location.search);
      const defaultVariant = urlParams.get('default-variant') ?
        parseInt(urlParams.get('default-variant')) :
        {{ defaultSelectionIndex | default: 1 }};

      const initialVariantIndex = defaultVariant ? defaultVariant - 1 : 0;

      // Handle initial inert state for subscription boxes
      purchaseOptionBoxes.forEach(box => {
        const subscriptionSellingPlanId = box.dataset.subscriptionSellingPlanId;
        if (!subscriptionSellingPlanId || subscriptionSellingPlanId === '0') {
          box.setAttribute('inert', '');
        }

        const subscriptionContent = box.querySelectorAll('.subscription-content');
        const buyOnceContent = box.querySelectorAll('.buy-once-content');

        box.classList.remove('selected');
        box.style.maxHeight = '68px';

        subscriptionContent.forEach(el => {
          el.style.display = 'block';
          el.style.opacity = '1';
        });

        buyOnceContent.forEach(el => {
          el.style.display = 'none';
          el.style.opacity = '0';
        });

        const radio = box.querySelector("input[type='radio']");
        if (radio) radio.checked = false;
      });

      // Find the first valid box for initial selection
      let defaultBox = purchaseOptionBoxes[initialVariantIndex];
      if (defaultBox && defaultBox.hasAttribute('inert')) {
        defaultBox = Array.from(purchaseOptionBoxes).find(box => !box.hasAttribute('inert'));
      }

      if (defaultBox) {
        defaultBox.classList.add('selected');
        adjustMaxHeight(defaultBox);

        const radio = defaultBox.querySelector("input[type='radio']");
        if (radio) radio.checked = true;

        const submitSellingPlanElement = productActions.querySelector('.submit-selling-plan-id');
        const submitVariantElement = productActions.querySelector('.submit-variant-id');

        if (submitSellingPlanElement) {
          submitSellingPlanElement.value = defaultBox.dataset.subscriptionSellingPlanId || '';
        }
        if (submitVariantElement) {
          submitVariantElement.value = defaultBox.dataset.originalVariant || defaultBox.dataset.variant;
        }

        const toggleIcon = defaultBox.querySelector('.toggle-icon');
        if (toggleIcon) toggleIcon.style.display = 'block';
      }

      const subscriptionButton = productActions.querySelector('.purchase-type .subscription');
      const buyOnceButton = productActions.querySelector('.purchase-type .buy-once');

      if (subscriptionButton && buyOnceButton) {
        subscriptionButton.classList.add('selected');
        buyOnceButton.classList.remove('selected');
      }

      if (defaultBox) {
        updateYotpoPointsWidget(defaultBox);
      }

      {% if variantsAmount > 1 %}
          if (defaultBox) {
            updateVariantImage(defaultBox);
          }
      {% endif %}
    }

    function setupMutationObserver() {
      const observer = new MutationObserver(mutations => {
        mutations.forEach(mutation => {
          if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
            const targetBox = mutation.target.closest('.purchase-option-box');
            if (targetBox?.classList.contains('selected')) {
              adjustMaxHeight(targetBox);
            }
          }
        });
      });

      purchaseOptionBoxes.forEach(element => {
        observer.observe(element, { attributes: true, attributeFilter: ['class'] });
      });
    }

    productActions.addEventListener('click', (event) => {
      const purchaseBox = event.target.closest('.purchase-option-box');
      if (purchaseBox) togglePurchaseBox(purchaseBox);

      const purchaseTypeButton = event.target.closest('.purchase-type button');
      if (purchaseTypeButton) handlePurchaseTypeClick(event, purchaseTypeButton);

      const checkoutButton = event.target.closest('.checkout-button subscription, .add-to-cart-button buy-once, .submit-wrap button.main-btn');
      if (checkoutButton) handleMainButtonClick(event, checkoutButton);
    });

    function handlePurchaseTypeClick(event, button) {
      event.stopPropagation();

      // Toggle button states
      productActions.querySelectorAll('.purchase-type button').forEach(btn => btn.classList.remove('selected'));
      button.classList.add('selected');

      const isSubscription = button.classList.contains('subscription');
      const submitSellingPlanElement = productActions.querySelector('.submit-selling-plan-id');

      // Set selling plan to blank if "Buy Once" is selected
      if (!isSubscription && submitSellingPlanElement) {
        submitSellingPlanElement.value = ''; // Clear the selling plan ID for "Buy Once"
      }

      // Update all variant boxes
      purchaseOptionBoxes.forEach(box => {
        const subscriptionContent = box.querySelectorAll('.subscription-content');
        const buyOnceContent = box.querySelectorAll('.buy-once-content');

        // First fade out current content
        const currentContent = isSubscription ? buyOnceContent : subscriptionContent;
        const newContent = isSubscription ? subscriptionContent : buyOnceContent;

        // Fade out current content
        currentContent.forEach(el => {
          el.style.opacity = '0';
        });

        // Wait for fade out to complete before showing new content
        setTimeout(() => {
          // Hide old content
          currentContent.forEach(el => {
            el.style.display = 'none';
          });

          // Show new content but keep it invisible
          newContent.forEach(el => {
            el.style.display = 'block';
            el.style.opacity = '0';
          });

          // Trigger fade in
          requestAnimationFrame(() => {
            newContent.forEach(el => {
              el.style.opacity = '1';
            });
          });
        }, 300);

        // Handle selling plan ID and inert state for subscription
        if (isSubscription) {
          const sellingPlanId = box.dataset.subscriptionSellingPlanId;
          if (!sellingPlanId || sellingPlanId === '0') {
            box.setAttribute('inert', '');
          } else {
            box.removeAttribute('inert');
          }
          // Only update selling plan if it's a subscription selection
          if (submitSellingPlanElement) {
            submitSellingPlanElement.value = sellingPlanId || ''; // Update for subscription
          }
        } else {
          box.removeAttribute('inert');
        }

        // Handle per month display
        {% unless product.metafields.custom.is_price_per_month %}
          const perMonthElement = box.querySelector('.per-month');
          if (perMonthElement) {
            perMonthElement.style.display = isSubscription ? 'block' : 'none';
          }
        {% endunless %}

        // Update compared at price display with the same fade timing
        const comparedAtPrice = box.querySelector('.compared-at-price');
        if (comparedAtPrice) {
          const itemPrice = parseFloat(box.dataset.itemPrice);
          const subscriptionItemPrice = parseFloat(box.dataset.subscriptionItemPrice);
          const originalItemCap = parseFloat(box.dataset.originalItemCap);
          const currentPrice = isSubscription ? subscriptionItemPrice : itemPrice;

          comparedAtPrice.style.opacity = '0';

          setTimeout(() => {
            if (originalItemCap > currentPrice) {
              comparedAtPrice.style.display = 'block';
              requestAnimationFrame(() => {
                comparedAtPrice.style.opacity = '1';
              });
            } else {
              comparedAtPrice.style.display = 'none';
            }
          }, 300);
        }
      });

      // Check if currently selected box becomes inert
      const selectedBox = productActions.querySelector('.purchase-option-box.selected');
      if (selectedBox && selectedBox.hasAttribute('inert')) {
        // Find the first non-inert box
        const firstAvailableBox = Array.from(purchaseOptionBoxes).find(box => !box.hasAttribute('inert'));
        if (firstAvailableBox) {
          // Deselect current box
          selectedBox.classList.remove('selected');
          selectedBox.style.maxHeight = '68px';
          const selectedToggleIcon = selectedBox.querySelector('.toggle-icon');
          if (selectedToggleIcon) selectedToggleIcon.style.display = 'none';

          // Select new box
          firstAvailableBox.classList.add('selected');
          adjustMaxHeight(firstAvailableBox);
          const newToggleIcon = firstAvailableBox.querySelector('.toggle-icon');
          if (newToggleIcon) newToggleIcon.style.display = 'block';

          // Update form values
          const submitSellingPlanElement = productActions.querySelector('.submit-selling-plan-id');
          const submitVariantElement = productActions.querySelector('.submit-variant-id');

          if (submitSellingPlanElement) {
            submitSellingPlanElement.value = isSubscription ? firstAvailableBox.dataset.subscriptionSellingPlanId : '';
          }
          if (submitVariantElement) {
            submitVariantElement.value = isSubscription ? firstAvailableBox.dataset.originalVariant : firstAvailableBox.dataset.variant;
          }

          // Update radio button
          const radioInput = firstAvailableBox.querySelector("input[type='radio']");
          if (radioInput) radioInput.checked = true;

          // Update other UI elements
          updateYotpoPointsWidget(firstAvailableBox);
          {% if variantsAmount > 1 %}
            updateVariantImage(firstAvailableBox);
          {% endif %}
        }
      }
    }

    function adjustMaxHeight(element) {
      const openHeight = element.scrollHeight;
      element.style.maxHeight = `${openHeight}px`;
    }

    function togglePurchaseBox(element) {
      if (element.classList.contains('selected')) return;

      // Update previous selected box
      const previousSelected = productActions.querySelector('.purchase-option-box.selected');
      if (previousSelected) {
        previousSelected.classList.remove('selected');
        previousSelected.style.maxHeight = '68px';
        const toggleIcon = previousSelected.querySelector('.toggle-icon');
        if (toggleIcon) toggleIcon.style.display = 'none';
      }

      // Update new selected box
      element.classList.add('selected');
      element.style.maxHeight = `${element.scrollHeight}px`;

      const toggleIcon = element.querySelector('.toggle-icon');
      if (toggleIcon) toggleIcon.style.display = 'block';

      // Update form values based on subscription state
      const isSubscription = isSubscriptionSelected();

      // Get the appropriate selling plan ID and variant ID
      const sellingPlanId = isSubscription ? element.dataset.subscriptionSellingPlanId : '';
      const variantId = isSubscription ? element.dataset.originalVariant : element.dataset.variant;

      // Find and update the form elements
      const submitSellingPlanElement = productActions.querySelector('.submit-selling-plan-id');
      const submitVariantElement = productActions.querySelector('.submit-variant-id');

      // Update selling plan ID
      if (submitSellingPlanElement) {
        submitSellingPlanElement.value = sellingPlanId;
      }

      // Update variant ID
      if (submitVariantElement) {
        submitVariantElement.value = variantId;
      }

      // Update radio button
      const radioInput = element.querySelector("input[type='radio']");
      if (radioInput) radioInput.checked = true;

      // Update other UI elements
      updateYotpoPointsWidget(element);

      {% if variantsAmount > 1 %}
          if (window.hasInitialImageUpdateHappened) {
            updateVariantImage(element);
          }
          window.hasInitialImageUpdateHappened = true;
      {% endif %}
    }

    function updateYotpoPointsWidget(parentBox) {
      const price = isSubscriptionSelected()
        ? parentBox.dataset.subscriptionItemPrice
        : parentBox.dataset.itemPrice;

      const newPoints = Math.floor(Number(price) / 100);
      const pointsElement = productActions.querySelector('.reward-points-widget .current-price');
      if (pointsElement) pointsElement.textContent = newPoints;
    }

    // Define showError and hideError functions
    function showError(message) {
      const errorMessageWrapper = document.querySelector('.product-form__error-message-wrapper');
      const errorMessage = document.querySelector('.product-form__error-message');

      if (errorMessageWrapper && errorMessage) {
        errorMessage.textContent = message;
        errorMessageWrapper.hidden = false;
      }
    }

    function hideError() {
      const errorMessageWrapper = document.querySelector('.product-form__error-message-wrapper');
      if (errorMessageWrapper) {
        errorMessageWrapper.hidden = true;
      }
    }

    const submitButton = document.getElementById('ProductSubmitButton-{{SID}}');
  submitButton.addEventListener('click', async function(event) {
    event.preventDefault();

    if (!productActions) {
      console.error('Product actions container not found');
      return;
    }

    // Display the loading spinner
    toggleButtonLoading(submitButton, true);

    try {
      const variantIdInput = productActions.querySelector('.submit-variant-id');
      const sellingPlanIdInput = productActions.querySelector('.submit-selling-plan-id');
      const selectedGiftContainers = document.querySelectorAll('.gift-option-container.selected');

      if (!variantIdInput) {
        throw new Error('Variant ID input not found');
      }

      const isSubscription = !!sellingPlanIdInput?.value;
      const variantId = variantIdInput.value;
      const sellingPlanId = sellingPlanIdInput ? sellingPlanIdInput.value : '';

      // Get all selected gift IDs
      const giftIds = Array.from(selectedGiftContainers).map(container => {
        const giftOptionBorder = container.querySelector('.gift-option-border');
        return isSubscription ? giftOptionBorder.dataset.giftIdSubscription : giftOptionBorder.dataset.giftId;
      });

      if (!variantId || giftIds.length === 0) {
        const errorMessage = `Missing required data: ${!variantId ? 'variant ID' : ''} ${giftIds.length === 0 ? 'gift selection' : ''}`;
        console.error(errorMessage);
        showNotification(errorMessage, 'error');
        return;
      }

      // Create array of items with main product and all selected gifts
      const items = [
			{
				id: variantId,
				product_id: currentProductId,
				quantity: 1,
				...(sellingPlanId && { selling_plan: sellingPlanId })
			},
			...giftIds.map(giftId => {
				const giftProductId = getProductIdByVariantId(giftId);
				return {
					id: giftId,
					product_id: giftProductId,
					quantity: 1
				};
			})
		];

      {% if buyType == "buy_now" %}
        // Delete cart drawer if it exists
        const cartDrawer = document.getElementById('upCart');
        if (cartDrawer) {
          cartDrawer.remove();
        }

        // Clean cart
        try {
          const clearCartResponse = await fetch('/cart/clear.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            }
          });

          if (!clearCartResponse.ok) {
            throw new Error('Failed to clear cart');
          }
        } catch (error) {
          console.error('Clear cart error:', error);
          showNotification('Failed to clear cart. Please try again.', 'error');
          return;
        }
      {% endif %}

      const result = await addValidItemsToCart(items);
      console.log('Add to cart result:', result);

      if (result.success) {
        {% if buyType == "buy_now" %}
          window.location.href = '/checkout';
        {% endif %}
      } else if (result.error) {
        showNotification(result.error.message || 'Failed to add items to cart', 'error');
      }
    } catch (error) {
      console.error('Submission error:', error);
      showNotification(error.message || 'An unexpected error occurred', 'error');
    } finally {
      toggleButtonLoading(submitButton, false);
    }
  });

// Helper function to find the corresponding failed validation result
function findFailedValidationIndex(validationResults, invalidItemIndex) {
  let failedCount = 0;
  for (let i = 0; i < validationResults.length; i++) {
    if (!validationResults[i].isValid) {
      if (failedCount === invalidItemIndex) {
        return i;
      }
      failedCount++;
    }
  }
  return -1;
}

async function validateCartItem(item, currentCart) {
  try {
    console.log('Validating item:', item);
    console.log('Current cart state during validation:', currentCart);

    const productId = parseInt(item.product_id);
    if (!productId) {
      throw new Error(`Product ID is missing for variant ${item.id}`);
    }

    // Check if this is a subscription item
    const isSubscription = !!item.selling_plan;

    if (isSubscription) {
      // Look for existing subscription items with the same product ID
      const existingSubscription = currentCart.items.find(cartItem =>
        cartItem.product_id === productId && cartItem.selling_plan_allocation
      );

      if (existingSubscription) {
        console.log('Found existing subscription for product:', productId);
        return {
          isValid: true,
          requiresReplacement: true,
          itemToRemove: existingSubscription
        };
      }
    }

    // Continue with regular gift validation
    const giftOptions = document.querySelectorAll('.gift-option-border');
    const isItemFree = Array.from(giftOptions).some(giftOption => {
      const giftId = isSubscriptionSelected()
        ? giftOption.dataset.giftIdSubscription
        : giftOption.dataset.giftId;
      return giftId === item.id.toString();
    });

    if (isItemFree) {
      const currentFreeItems = currentCart.items.filter(cartItem => {
        return Array.from(giftOptions).some(giftOption => {
          const giftId = isSubscriptionSelected()
            ? giftOption.dataset.giftIdSubscription
            : giftOption.dataset.giftId;
          return cartItem.variant_id.toString() === giftId;
        });
      });

      // Always allow 2 gifts instead of calculating BFCM count
      const allowedGiftCount = 2;

      if (currentFreeItems.length >= allowedGiftCount) {
        return {
          isValid: false,
          error: {
            code: 'FREE_ITEM_LIMIT',
            message: `You can have up to ${allowedGiftCount} free gift${allowedGiftCount !== 1 ? 's' : ''} in your cart.`,
            type: 'error'
          }
        };
      }
    }

    return { isValid: true };
  } catch (error) {
    console.error('Validation error:', error);
    return {
      isValid: false,
      error: {
        code: 'VALIDATION_ERROR',
        message: 'Unable to validate item. Please try again.',
        type: 'error'
      }
    };
  }
}

// Updated addValidItemsToCart function to use simplified gift validation
async function addValidItemsToCart(items) {
  try {
    // Always fetch the latest cart data
    const cartResponse = await fetch('/cart.js');
    if (!cartResponse.ok) {
      throw new Error('Failed to fetch current cart');
    }
    let currentCart = await cartResponse.json();
    console.log('Current cart state:', currentCart);

    // First, validate all items and check for subscription replacements
    const validationResults = await Promise.all(
      items.map(item => validateCartItem(item, currentCart))
    );

    console.log('Validation results:', validationResults);

    // Handle subscription replacements first
    const subscriptionReplacements = validationResults
      .filter(result => result.requiresReplacement)
      .map(result => result.itemToRemove);

    if (subscriptionReplacements.length > 0) {
      // Remove existing subscription items that need to be replaced
      console.log('Removing existing subscriptions:', subscriptionReplacements);

      const updates = {};
      subscriptionReplacements.forEach(item => {
        updates[item.key] = 0;  // Set quantity to 0 to remove the item
      });

      const removeResponse = await fetch('/cart/update.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ updates })
      });

      if (!removeResponse.ok) {
        throw new Error('Failed to remove existing subscription items');
      }

      // Refresh cart data after removals
      const updatedCartResponse = await fetch('/cart.js');
      currentCart = await updatedCartResponse.json();
    }

    // Get valid items and invalid items
    const validItems = items.filter((_, index) => validationResults[index].isValid);
    const invalidItems = items.filter((_, index) => !validationResults[index].isValid);

    // Show notifications for invalid items
    invalidItems.forEach((_, index) => {
      const result = validationResults[findFailedValidationIndex(validationResults, index)];
      if (result?.error) {
        showNotification(result.error.message, result.error.type);
      }
    });

    // If we have valid items, add them to cart
    if (validItems.length > 0) {
      const response = await fetch('/cart/add.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ items: validItems })
      });

      if (!response.ok) {
        throw new Error('Failed to add items to cart');
      }

      // Show appropriate notification
      if (subscriptionReplacements.length > 0) {
        showNotification('Subscription has been updated in your cart', 'success');
      } else if (invalidItems.length > 0) {
        showNotification('Some items were added to cart, but free gift limit was exceeded', 'info');
      } else {
        showNotification('Items added to cart successfully', 'success');
      }

      return {
        success: true,
        addedItems: validItems,
        failedItems: invalidItems,
        replacedItems: subscriptionReplacements
      };
    }

    // If no valid items
    return {
      success: false,
      addedItems: [],
      failedItems: invalidItems,
      error: {
        message: 'No items could be added to cart',
        type: 'error'
      }
    };
  } catch (error) {
    console.error('Error adding items to cart:', error);
    showNotification('An error occurred while adding items to cart. Please try again.');
    return {
      success: false,
      addedItems: [],
      failedItems: items
    };
  }
}

async function countUniqueProductsWithTag(cart) {
  try {
    // Use the product title to check for 'Cyber Monday Week'
    const uniqueProducts = cart.items.reduce((acc, item) => {
      if (acc[item.product_id]) {
        return acc;
      }

      const hasBlackFridayWeek = item.title && item.title.includes('Cyber Monday Week');
      console.log('Checking item:', item.title, 'Has BF Week:', hasBlackFridayWeek);

      acc[item.product_id] = hasBlackFridayWeek;
      return acc;
    }, {});

    const blackFridayWeekCount = Object.values(uniqueProducts).filter(Boolean).length;

    return Math.max(blackFridayWeekCount, 1);
  } catch (error) {
    console.error('Error counting Cyber Monday Week products:', error);
    return 1; // Default to 1 if there's an error
  }
}

    function showNotification(message, type = 'error') {
      if (!{{ isCartNotifications | default: false }}) {
        return;
      }

      const notification = document.createElement('div');
      notification.className = `cart-notification ${type} fixed bottom-4 left-1/2 transform -translate-x-1/2 p-4 rounded-lg shadow-lg max-w-md z-50 transition-opacity duration-300 z-[2147483640]`;

      // Style based on type
      if (type === 'error') {
        notification.classList.add('bg-red-100', 'border', 'border-red-400', 'text-red-700');
      } else if (type === 'success') {
        notification.classList.add('bg-green-100', 'border', 'border-green-400', 'text-green-700');
      } else if (type === 'info') {
        notification.classList.add('bg-blue-100', 'border', 'border-blue-400', 'text-blue-700');
      }

      // Add content
      notification.innerHTML = `
        <div class="flex items-center">
          <div class="mr-3">
            ${type === 'error' ? '⚠️' : type === 'success' ? '✅' : 'ℹ️'}
          </div>
          <div class="text-sm font-medium">
            ${message}
          </div>
          <button class="hover:text-gray-500 ml-auto text-gray-400" onclick="this.parentElement.parentElement.remove()">
            ✕
          </button>
        </div>
      `;

      // Add to document
      document.body.appendChild(notification);

      // Remove after 5 seconds
      setTimeout(() => {
        notification.classList.add('opacity-0');
        setTimeout(() => notification.remove(), 300);
      }, 5000);
    }

    function toggleButtonLoading(buttonElement, isLoading) {
      if (!buttonElement) {
        console.error('Button element not found in toggleButtonLoading');
        return;
      }

      const loader = buttonElement.querySelector('.loading-overlay__spinner');
      const buttonText = buttonElement.querySelector('.button-text, .submit-title');

      if (!loader || !buttonText) {
        console.error('Loader or buttonText element not found');
        return;
      }

      loader.style.display = isLoading ? 'block' : 'none';
      buttonText.style.display = isLoading ? 'none' : 'block';
    }

    // Function to update the variant image
    function updateVariantImage(element) {
      if (!element || !element.dataset.index) {
        return;
      }

      const SID = window.SID || '';
      const sliderId = `productSliderAllInOne${SID}`;
      const slider = window[sliderId];

      if (!slider || !slider.slides || !slider.slides.length) {
        initializeProductSlider()
          .then((initializedSlider) => {
            performSlideUpdate(initializedSlider, element);
          })
          .catch((error) => {
            console.error('Failed to initialize slider:', error);
          });
        return;
      }

      performSlideUpdate(slider, element);
    }

    function performSlideUpdate(slider, element) {
      try {
        const elementIndex = parseInt(element.dataset.index);

        if (elementIndex >= 0 && elementIndex < slider.slides.length) {
          if (slider.activeIndex !== elementIndex) {
            setTimeout(() => {
              slider.slideTo(elementIndex, 300, true);
            }, 50);
          }
        }
      } catch (error) {
        console.error('Error during slide update:', error);
        console.error(error.stack);
      }
    }
  });
</script>

<style>
	.gift-selector-wrap {
		margin: 1rem 0;
	}

	.gift-option-border {
		transition: all 0.3s ease;
		border: 2px solid #e5e7eb;
		background: #fff;
		width: 120px;
		height: 120px;
	}

	.gift-option-border:hover {
		border-color: var(--primary-color-lighter);
	}

	.gift-option-container.selected .gift-option-border {
		border-color: var(--primary-color);
		background-color: rgba(var(--primary-color-rgb), 0.05);
	}

	.check-mark {
		transition: all 0.2s ease;
		margin-top: -4px;
		margin-left: 3px;
	}

	.check-mark.hidden {
		display: none;
	}

	.radio-indicator {
		transition: all 0.2s ease;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 16px;
	}

	.gift-option-container.selected .radio-indicator {
		background-color: var(--primary-color);
	}

	.sale-price {
		color: var(--primary-color-dark);
	}

	/* Add styles to indicate when max gifts are selected */
	.gift-option-container:not(.selected) {
		opacity: 0.7;
		transition: opacity 0.3s ease;
	}

	.gift-option-container:not(.selected):hover {
		opacity: 1;
	}
</style>

<style>
	:root {
	  --primary-color: {{ buyBoxColor }};
	  --primary-color-dark: color-mix(in srgb, var(--primary-color), black 20%);
	 --primary-color-light: color-mix(in srgb, var(--primary-color), white 60%);
	  --primary-color-lighter: color-mix(in srgb, var(--primary-color), white 80%);
	}

	#cta-section-{{ SID }} .purchase-type button {
	  background-color: var(--primary-color);
	  color: black;
	  border-radius: 5px;
	  font-size: 16px;
	  min-width: 49%;
	  padding: 0.5rem;

	  &.selected {
	    color: white !important;
	  }

	  &:not(.selected) {
	    background: var(--primary-color-lighter);
	    border: 1px solid var(--primary-color);

	    .subscription-details {
	      color: var(--primary-color-dark);
	    }
	  }
	}

	#cta-section-{{ SID }} .purchase-option-box .radio-box input[type='radio'] {
	    display: none;
	}

	#cta-section-{{ SID }} .purchase-option-box .radio-box label {
	    cursor: pointer;
	    width: 19px;
	    height: 19px;
	    border: 1px solid var(--primary-color);
	    border-radius: 50%;
	    position: relative;
	}

	#cta-section-{{ SID }} .purchase-option-box.selected .radio-box input[type='radio']:checked + label:after {
	    content: '\2713';
	    position: absolute;
	    top: -2px;
	    left: -2px;
	    width: 20px;
	    height: 20px;
	    border-radius: 50%;
	    background: var(--primary-color);
	    text-align: center;
	    line-height: 22px;
	    color: #fff;
	}

	#cta-section-{{ SID }} .product-actions {
	  grid-area: 2/2/3/3;
	  min-height: 415px;

	  @media (width < 768px) {
	    grid-area: unset;
	    grid-row: 3;
	    max-width: unset;
	    min-height: unset;
	  }
	}

	#cta-section-{{ SID }} .purchase-option-box {
	  background: #fff;
	  border: 1px solid #cbcbcb;
	  cursor: pointer;
	  max-height: 68px;
	  filter: drop-shadow(0px 4px 4px rgba(47, 47, 47, 0.1));
	  transition: max-height 0.5s ease-in-out;
	  border-radius: 10px;
	  border-color: var(--primary-color);
	  overflow: hidden;
	  padding: 0.75rem 1rem;

	  &:hover {
	    filter: drop-shadow(0px 4px 4px rgba(77, 53, 98, 0.3));
	  }

	  &.selected {
	    filter: drop-shadow(0px 4px 4px rgba(77, 53, 98, 0.3));
	    border-width: 3px;
	    max-height: max-content;
	  }

	  &[inert] {
	    max-height: 68px !important;
	    background: #ededed;
	    opacity: 0.6;

	    .option-title {
	      color: grey;
	    }
	  }

	  @media (width < 1270px) {
	    width: 100%;
	  }

	  @media (width < 768px) {
	    font-size: 4vw;
	  }

	  .radio-box {
	    align-items: center;
	    display: flex;

	    @media (width < 768px) {
	      padding: 3vw 0;
	    }
	  }

	  .price-wrapper {
	    .total-price {
	      color: var(--primary-color-dark);
	    }

	    .compared-at-price {
	      color: var(--primary-color-light);
	    }
	  }
	}

	.subscription-content,
	.buy-once-content,
	.subtitle.subscription,
	.subtitle.buy-once {
	  transition: opacity 0.3s ease-in-out;
	}

	/* Initial states */
	.subscription-content,
	.buy-once-content,
	.subtitle.subscription,
	.subtitle.buy-once {
	  opacity: 0;
	  display: none;
	}

	/* Active states */
	.subscription-content.active,
	.buy-once-content.active,
	.subtitle.subscription.active,
	.subtitle.buy-once.active {
	  opacity: 1;
	  display: block;
	}
</style>
