{%- assign variantQuantity = product.variants | size -%}
{%- assign first_3d_model = product.media | where: 'media_type', 'model' | first -%}

<div id="product-thumbnails-{{ SID }}" class="product-thumbnails">
	<div class="product-slider">
		<div class="sliders-group {% if thumbs == 'horizontal' %}flex flex-col-reverse gap-4{% endif %}">
			{% unless thumbs == 'none' %}
				<div class="thumbs-slider relative">
					<div id="product-thumbs-slider-nav-prev-{{ SID }}" class="swiper-nav swiper-button-prev"></div>

					<div id="thumbs-slider-{{ SID }}" class="swiper">
						<div class="swiper-wrapper">
							{% comment %} Render Product Images on Thumbs Slider {% endcomment %}
							{% if isProductThumbs %}
								{% for img in product.images %}
									<div class="swiper-slide cursor-pointer !h-auto">
										{% render 'image', image: img, lazy: false, preload: true, alt: img.alt %}
									</div>
								{% endfor %}
							{% endif %}

							{% comment %} Render Section Images on Thumbs Slider {% endcomment %}
							{% for block in section.blocks %}
								{% if block.type == 'image' %}
									<div class="swiper-slide cursor-pointer !h-auto">
										{% render 'image', image: block.settings.product_img, lazy: false, preload: true, alt: block.settings.product_img.alt %}
									</div>
								{% elsif block.type == 'video' %}
									<div class="swiper-slide cursor-pointer !h-auto">
										<div class="thumbs-img video-thumbnail">
											<img src="{{ block.settings.video_thumbnail | image_url }}" width="720" height="680" alt="" loading="lazy">
										</div>
									</div>
								{% endif %}
							{% endfor %}

							{%- if first_3d_model -%}
								<div class="swiper-slide cursor-pointer !h-auto">
									<img class="p-1" src="https://cdn.shopify.com/s/files/1/0452/2459/1511/files/single_supp.png?v=1704621391" width="291" height="278" alt="Product Image" loading="lazy">
									<i class="fa-light fa-360-degrees model-icon"></i>
								</div>
							{%- endif -%}
						</div>
					</div>

					<div id="product-thumbs-slider-nav-next-{{ SID }}" class="swiper-nav swiper-button-next"></div>
				</div>
			{% endunless %}

			<div class="main-slider {% if thumbs == 'vertical' %}dsk:ml-[160px]{% endif %}">
				<div id="product-main-slider-sc-{{ SID }}" class="swiper">
					<div class="swiper-wrapper">
						{% if thumbnailImage %}
							<div class="swiper-slide product-image-slide">
								{% if request.path contains 'lp-wl-curaslim-360-aff-bogo' %}
									<img src="{{ "product_image.png" | file_url }}" alt="CuraSlim" loading="lazy">
								{% else %}
									{% render 'image', image: thumbnailImage, lazy: false, preload: true, alt: thumbnailImage.alt %}
								{% endif %}
							</div>
						{% else %}
							{% if isProductThumbs %}
								{% for img in product.images %}
									{% if forloop.index == 1 %}
										{% assign currentImg = img %}
										{% assign img = thumbnailImage | default: currentImg %}
									{% endif %}

									<div class="swiper-slide product-image-slide">
										{% render 'image', image: img, lazy: false, preload: true, alt: img.alt %}
									</div>
								{% endfor %}
							{% endif %}

							{% if badgeImage %}
								{% render 'image', image: img, lazy: false, preload: true, alt: img.alt, class: 'sale-badge' %}
							{% endif %}

							{% comment %} Render Section Images on Main Slider {% endcomment %}
							{% for block in section.blocks %}
								{% if block.type == 'image' %}
									<div class="swiper-slide image-block-slide">
										{% render 'image', image: block.settings.product_img, lazy: false, preload: true, alt: block.settings.product_img.alt %}
									</div>
								{% elsif block.type == 'video' %}
									<div class="swiper-slide video-block-slide">
										<div class="product-video">
											<iframe
												id="product-video-iframe"
												src="https://player.vimeo.com/video/{{ block.settings.vimeo_video_id }}?playsinline=0"
												frameborder="0"
												webkitallowfullscreen
												mozallowfullscreen
												allowfullscreen
												loading="lazy"></iframe>
										</div>
									</div>
								{% endif %}
							{% endfor %}

							{%- if first_3d_model -%}
								<div class="swiper-slide 3d-image-slide">
									<model-viewer
										class="w-full h-[500px] md:h-[80vw]"
										alt="Curalin"
										src="{{ first_3d_model.sources.first.url }}"
										poster="//curalife.com/cdn/shop/files/curalinsdsdv.png?v=1704651801"
										shadow-intensity="1"
										camera-controls
										camera-orbit="300deg 80deg"
										auto-rotate></model-viewer>
								</div>
							{%- endif -%}

							{% comment %} Render Vaiants on Main Slider {% endcomment %}
							{% if product.variants.size > 1 %}
								{% for var in product.variants %}
									<div class="swiper-slide variant-image-slide" data-variant-id="{{ var.id }}">
										{% if var.image %}
											{% render 'image', image: var.image, lazy: false, preload: true, alt: var.image.alt %}
										{% endif %}

										{% if badgeImage %}
											{% render 'image', image: badgeImage, lazy: false, preload: true, alt: badgeImage.alt, class: 'sale-badge' %}
										{% endif %}
									</div>
								{% endfor %}
							{% endif %}

							{% if customer.email == 'yotam@curalife.com' %}
								{% for additionalVariant in product.metafields.custom.additional_variants.value %}
									<div class="swiper-slide">
										{% render 'image', image: additionalVariant.image, lazy: false, preload: true, alt: additionalVariant.image.alt %}

										{% if badgeImage %}
											{% render 'image', image: badgeImage, lazy: false, preload: true, alt: badgeImage.alt, class: 'sale-badge' %}
										{% endif %}
									</div>
								{% endfor %}
							{% endif %}
						{% endif %}
					</div>

					<div class="swiper-pagination"></div>
					<div id="product-main-slider-nav-prev-{{ SID }}" class="swiper-button-prev product-main-slider-nav-prev swiper-nav"></div>
					<div id="product-main-slider-nav-next-{{ SID }}" class="swiper-button-next product-main-slider-nav-next swiper-nav"></div>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
	document.addEventListener('DOMContentLoaded', function() {
	  {% unless thumbs == 'none' %}
	    loadSwiper(() => {
	      window.productThumbsSlider{{ SID }} = initializeSwiper('#thumbs-slider-{{ SID }}', {
					{% if thumbs == 'vertical' %}direction: 'vertical',{% endif %}
	        spaceBetween: 10,
	        watchSlidesVisibility: true,
	        grabCursor: true,
	        slideToClickedSlide: true,
	        slidesPerView: 3,
	        watchSlidesProgress: true,
	        navigation: {
	          nextEl: '#product-thumbs-slider-nav-next-{{ SID }}',
	          prevEl: '#product-thumbs-slider-nav-prev-{{ SID }}',
	          disabledClass: 'disabled'
	        },
	        on: {
	          slideChange: function() {
	            if (window.productSliderAllInOne{{ SID }}) {
	              window.productSliderAllInOne{{ SID }}.slideTo(this.activeIndex);
	            }
	          }
	        }
	      });
	    });
	  {% endunless %}

	  loadSwiper(() => {
	    window.productSliderAllInOne{{ SID }} = initializeSwiper('#product-main-slider-sc-{{ SID }}', {
	      {% unless thumbs == 'none' %}
	      thumbs: {
	        swiper: window.productThumbsSlider{{ SID }},
	        multipleActiveThumbs: false
	      },
	      {% endunless %}
	      slidesPerView: 1,
	      spaceBetween: 15,
	      watchSlidesVisibility: true,
	      grabCursor: false,
	      slideToClickedSlide: true,
	      breakpoints: {
	        0: {
	          navigation: {
	            nextEl: '#product-main-slider-nav-next-{{ SID }}',
	            prevEl: '#product-main-slider-nav-prev-{{ SID }}',
	            disabledClass: 'disabled'
	          }
	        },
	        760: {
	          grabCursor: true,
	          navigation: {}
	        }
	      },
	      on: {
	        slideChange: function () {
	          {% unless thumbs == 'none' %}
	          try {
	            if (!this.thumbs || !this.thumbs.swiper) return;

	            const thumbsSwiper = this.thumbs.swiper;
	            if (!thumbsSwiper.slides || thumbsSwiper.slides.length === 0) return;

	            const activeIndex = this.activeIndex;
	            const visibleSlidesStart = thumbsSwiper.activeIndex;
	            const visibleSlidesEnd = visibleSlidesStart + thumbsSwiper.params.slidesPerView;

	            if (activeIndex + 1 >= visibleSlidesEnd) {
	              thumbsSwiper.slideNext();
	            } else if (activeIndex < visibleSlidesStart) {
	              thumbsSwiper.slidePrev();
	            }
	          } catch (error) {
	            console.warn('Thumb navigation error:', error);
	          }
	          {% endunless %}
	        }
	      }
	    });
	  });
	});
</script>

<style>
	#product-thumbnails-{{ SID }} {
		--swiper-navigation-sides-offset: -45px;
		grid-area: 1/1/3/2;

		{% if first_3d_model %}
			.model-icon {
				position: absolute;
				top: 25%;
				left: 25%;
				font-size: 10px;
				color: white;
				border-radius: 50%;
				border: 2px solid white;
				width: 30%;
				height: 30%;
				padding: 0.5rem;
				background: rgba(255,255,255,0.2);
			}
		{% endif %}

		{% if badgeImage %}
			.sale-badge {
				position: absolute;
				top: 10px;
				right: 50px;
				width: 100px;
				z-index: 1;

				@media screen and (max-width: 768px) {
					top: 0;
					right: 0;
					width: 25vw;
				}
			}
		{% endif %}

		.product-slider {
			.main-slider {
				.swiper-slide {
					img {
						border-radius: 10px;
					}

					.product-video iframe {
						height: 480px;
						width: 100%;
					}
				}

				.swiper-nav {
					display: none;

					&::after {
						font-size: 12px;
						color: var(--blue);
						font-weight: bold;
					}

					&.disabled {
						opacity: 0;
					}
				}

				.swiper-button-prev,
				.swiper-button-next {
					&.disabled {
						opacity: 0;
					}
				}
			}

			.thumbs-slider {
				{% if thumbs == 'vertical' %}
					.swiper-wrapper {
						display: absolute !important;

						.swiper {
							max-height: 320px;
						}

						.swiper-nav {
							transform: rotate(90deg);
							width: 30px;
							height: 30px;
							position: relative;
							left: 30px;

							&.swiper-button-next {
								bottom: -20px;
							}

							&.swiper-button-prev {
								top: -10px;
							}
						}
					}
				{% else %}
					width: 80%;
					margin: 0 auto;

					.swiper {
						margin-left: 13px;
					}
				{% endif %}

				.swiper-nav {
					&:after {
						font-size: 12px;
					}

					&.disabled {
						opacity: 0;
					}

					&:active {
						box-shadow: unset !important;
					}
				}

				.swiper-wrapper img {
					--thumb-size: {% if thumbs == 'vartical'%}100px{% else %}150px{% endif %};
					width: var(--thumb-size);
					height: var(--thumb-size);
					border-radius: 5px;
					border: 1px solid var(--primary-color-light);
					object-fit: cover;
					display: flex;
					justify-content: center;
					align-items: center;
					padding: 0.5rem;
				}
			}
		}

		.product-template-all-in-one {
			.swiper-button-prev,
			.swiper-button-next {
				&::after {
					font-size: 28px;
				}
			}
		}

		@media screen and (max-width: 768px) {
			grid-area: unset;
			grid-row: 2;

			.product-slider {
				margin-left: unset;

				.sliders-group:before {
					content: "";
					width: 100vw;
					position: absolute;
					top: 0;
					right: 50%;
					bottom: 0;
					z-index: -1;
					transform: translate(50%);
					pointer-events: none;
				}

				.main-slider {
					.main-slider-vector-bg {
						margin-left: unset;
						left: 0;
						top: 10%;
					}

					.swiper {
						overflow: visible !important;
					}

					.swiper-wrapper {
						align-items: center;

						.swiper-slide {
							.product-video {
								iframe {
									height: 45vh;

									.vp-video-wrapper {
										border-radius: 10px;
									}
								}
							}

							.product-img::before {
								padding-bottom: 100%;
							}
						}
					}

					.swiper-nav {
						display: flex;

						&.swiper-button-prev {
							left: -10px;
						}

						&.swiper-button-next {
							right: -10px;
						}
					}

					.swiper-pagination {
						.swiper-pagination-bullet {
							background: var(--green);
							opacity: .4;
							width: 13px;
							height: 13px;
							border: 0;

							&.swiper-pagination-bullet-active {
								background: var(--green);
								opacity: 1;
							}
						}
					}
				}

				.thumbs-slider {
					display: none;
				}
			}
		}
	}
</style>
