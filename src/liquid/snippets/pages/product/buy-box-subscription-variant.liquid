{% comment %}
	Purchase Option Box Template
	- Handles both subscription and one-time purchase options
	- Calculates prices, savings, and displays appropriate UI elements
{% endcomment %}

{% comment %} Core Variable Assignments {% endcomment %}
{% assign variant_id = var.metafields.custom.reference_variant_id | default: var.id %}
{% assign bottle_quantity = var.metafields.my_fields.pack_bottles_quantity %}

{% comment %} Price Calculations {% endcomment %}
{% assign original_item_price = var.metafields.custom.original_item.value.price %}
{% assign original_item_cap = var.metafields.custom.original_item.value.compare_at_price | default: original_item_price %}
{% assign original_item_cap_total = original_item_cap | times: bottle_quantity %}
{% assign item_price = var.price | divided_by: bottle_quantity %}

{% comment %} Subscription-specific Calculations {% endcomment %}
{% assign subscription_save_percents = var.metafields.subscription.save_percents %}
{% assign subscription_item_price_save = original_item_cap | times: subscription_save_percents | divided_by: 100 %}
{% assign subscription_item_price = original_item_cap | minus: subscription_item_price_save %}
{% assign subscription_total_price = subscription_item_price | times: bottle_quantity %}

{% comment %} Savings Calculations {% endcomment %}
{% assign subscription_save_money = original_item_cap | minus: subscription_item_price %}
{% assign buy_once_save_money = original_item_cap | minus: item_price %}

{% comment %} Selling Plan ID Logic {% endcomment %}
{% if var.metafields.custom.referenced_variant_product_handle %}
	{% assign prod = all_products[var.metafields.custom.referenced_variant_product_handle] %}
	{% assign referenced_variant = prod.variants | where: 'id', variant_id | first %}
	{% assign selling_plan_id = referenced_variant.metafields.subscription.selling_plan_id | default: variant.metafields.subscription.selling_plan_id %}
{% elsif var.metafields.subscription.selling_plan_id %}
	{% assign selling_plan_id = var.metafields.subscription.selling_plan_id %}
{% elsif var.selling_plan_allocations.size > 0 %}
	{% for allocation in var.selling_plan_allocations %}
		{% if allocation.selling_plan.name contains bottle_quantity %}
			{% assign selling_plan_id = allocation.selling_plan.id %}
		{% endif %}
	{% endfor %}
{% else %}
	<script>
		console.log("Didn't find selling plan for the variant");
	</script>
{% endif %}

{% comment %} Main Purchase Option Box HTML {% endcomment %}
<div
	id="purchase-option-box-{{ SID }}-{{ index }}"
	class="purchase-option-box flex flex-col w-full {% if index == 1 %}selected{% endif %} {{ purchase_type }}"
	data-variant="{{ variant_id }}"
	data-product="{{ prod.id }}"
	data-original-variant="{{ var.id }}"
	data-subscription-selling-plan-id="{{ selling_plan_id }}"
	data-price="{{ var.price | money_without_currency | replace: ".00", "" }}"
	data-sku="{{ var.sku }}"
	data-index="{{ index }}"
	data-item-price="{{ item_price }}"
	data-subscription-item-price="{{ subscription_item_price }}"
	data-original-item-cap="{{ original_item_cap }}"
	data-dc="{{ var.metafields.custom.discount_code | base64_encode }}"
	data-buy-once-discount="{{ var.metafields.custom.save_percents }}"
	data-subscription-discount="{{ var.metafields.subscription.save_percents }}"
	data-price-per="{{ pricePer }}"
	data-bottle-quantity="{{ bottle_quantity }}"
	data-purchase-type="{{ purchase_type }}"
	data-buy-type="{{ buyType }}"
	name="variant-box-{{ var.sku }}-{{ purchase_type }}">
	{% comment %} Top Section: Radio Button and Title {% endcomment %}
	<div class="top-wrapper flex items-center justify-between w-full gap-4">
		<div class="radio-box hidden">
			<div class="radio-input">
				<input type="radio" name="variant-selection-{{ SID }}" id="variant-{{ SID }}-{{ index }}">
			</div>
		</div>
		<div class="titles max-w-max flex flex-col justify-center">
			<div class="option-title content-center font-semibold text-[16px]">
				{% if var.title == 'Default Title' %}
					{{ prod.title }}
				{% else %}
					{{ variantTitle | default: var.title }}
				{% endif %}
			</div>
		</div>
	</div>
</div>
