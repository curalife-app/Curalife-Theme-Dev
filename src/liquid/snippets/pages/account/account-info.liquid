{% comment %}
  Account Information Snippet

  This snippet displays the customer's contact information and shipping address in the account page.
  It also handles displaying success messages after contact information is updated.
  It now includes password change functionality right in the same card.

  Usage:
  {% render 'account-info' %}

  Dependencies:
  - Requires customer object to be available
  - Expects certain CSS classes to be defined in the parent template
  - Handles the contact-updated URL parameter for success messages
{% endcomment %}

<div class="account-info-container">
  <div class="info-section contact-section">
    <div class="section-header">
      <h3 class="section-title">Contact Information</h3>
    </div>
    <div class="section-content">
      <div class="contact-info">
        <ul class="info-list no-style">
          <li class="info-item">
            <span class="info-label">First Name</span>
            <span class="info-value">{{ customer.first_name }}</span>
          </li>
          <li class="info-item">
            <span class="info-label">Last Name</span>
            <span class="info-value">{{ customer.last_name }}</span>
          </li>
          <li class="info-item">
            <span class="info-label">Email</span>
            <span class="info-value">{{ customer.email }}</span>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <div class="info-section address-section">
    <div class="section-header">
      <h3 class="section-title">Shipping Address</h3>
      <a href="/account/addresses" class="action-button address-edit-link" title="Manage Addresses">
        <span class="action-text">Manage</span>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
      </a>
    </div>
    <div class="section-content">
      {% assign address = customer.default_address %}
      {% if address %}
        <div class="address-display">
          <p>
            {{ address.first_name }} {{address.last_name }}
            {% if address.company != blank %}<br />{{ address.company }}{% endif %}
            {% if address.street != blank %}<br />{{ address.street }}{% endif %}
            <br />{{ address.city }} {% if address.province_code != blank %}, {{ address.province_code }}{% endif %}
            <br />{{ address.country }} {{ address.zip }}
            {% if address.phone != blank %}<br />{{ address.phone }}{% endif %}
          </p>
        </div>
      {% else %}
        <div class="empty-address">
          <p>You don't have a shipping address yet. <a href="/account/addresses" class="add-address-link">Add one now</a></p>
        </div>
      {% endif %}
    </div>
  </div>

  <div class="info-section password-section">
    <div class="section-header">
      <h3 class="section-title">Password Management</h3>
      <button type="button" class="action-button toggle-password-form" aria-label="Toggle password change form">
        <span class="action-text">Change</span>
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
      </button>
    </div>
    <div class="section-content">
      <div class="password-form-wrapper" style="display: none;">
        {% form 'customer' %}
          <div class="form-fields">
            <div class="form-group">
              <label for="CustomerCurrentPassword">Current Password</label>
              <div class="password-input-wrapper">
                <input type="password" name="customer[current_password]" id="CustomerCurrentPassword" required>
                <button type="button" class="toggle-password-visibility no-style" aria-label="Toggle password visibility">
                  <svg class="eye-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                  <svg class="eye-off-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                </button>
              </div>
            </div>

            <div class="form-group">
              <label for="CustomerNewPassword">New Password</label>
              <div class="password-input-wrapper">
                <input type="password" name="customer[password]" id="CustomerNewPassword" required>
                <button type="button" class="toggle-password-visibility no-style" aria-label="Toggle password visibility">
                  <svg class="eye-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                  <svg class="eye-off-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                </button>
              </div>
              <div class="password-strength-meter">
                <div class="strength-label"></div>
                <div class="meter-bar">
                  <span class="strength-value"></span>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="CustomerPasswordConfirmation">Confirm New Password</label>
              <div class="password-input-wrapper">
                <input type="password" name="customer[password_confirmation]" id="CustomerPasswordConfirmation" required>
                <button type="button" class="toggle-password-visibility no-style" aria-label="Toggle password visibility">
                  <svg class="eye-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                  <svg class="eye-off-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                </button>
              </div>
            </div>
          </div>

          <input type="hidden" name="return_to" value="/account?password-updated=true#a">

          <div class="form-actions">
            <button type="submit" class="primary-button">Update Password</button>
            <button type="button" class="secondary-button cancel-password-btn">Cancel</button>
          </div>
        {% endform %}
      </div>
    </div>
  </div>
</div>

<style>
  /* Modern Account Information Styles */
  .account-info-container {
    display: grid;
    gap: 30px;
  }

  .info-section {
    background-color: white;
    border-radius: 16px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.05);
    overflow: hidden;
    position: relative;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .info-section:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 30px rgba(0,0,0,0.08);
  }

  .info-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: linear-gradient(to bottom, var(--blue), rgba(var(--blue-rgb), 0.7));
    border-radius: 2px;
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 25px;
    border-bottom: 1px solid rgba(0,0,0,0.06);
  }

  .section-title {
    font-size: 20px;
    font-weight: 700;
    margin: 0;
    color: var(--dark);
  }

  .section-content {
    padding: 25px;
  }

  /* Info list styling */
  .info-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    gap: 15px;
  }

  .info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(0,0,0,0.06);
  }

  .info-item:last-child {
    padding-bottom: 0;
    border-bottom: none;
  }

  .info-label {
    font-size: 15px;
    color: var(--gray);
    font-weight: 500;
  }

  .info-value {
    font-size: 16px;
    color: var(--dark);
    font-weight: 600;
    text-align: right;
  }

  /* Address styling */
  .address-display, .empty-address {
    background-color: rgba(0,0,0,0.02);
    border-radius: 10px;
    padding: 20px;
    border: 1px solid rgba(0,0,0,0.06);
  }

  .address-display p {
    margin: 0;
    line-height: 1.8;
    color: var(--dark);
    font-size: 15px;
  }

  .empty-address {
    background-color: rgba(var(--blue-rgb), 0.05);
    border-style: dashed;
  }

  .empty-address p {
    margin: 0;
    color: var(--gray);
    font-size: 15px;
    text-align: center;
  }

  .add-address-link {
    color: var(--blue);
    text-decoration: none;
    font-weight: 600;
    display: inline-block;
    border-bottom: 2px solid currentColor;
    line-height: 1.2;
    margin-left: 5px;
    transition: all 0.3s ease;
  }

  .add-address-link:hover {
    opacity: 0.8;
  }

  /* Action buttons */
  .action-button {
    display: flex;
    align-items: center;
    gap: 8px;
    background-color: rgba(var(--blue-rgb), 0.1);
    color: var(--blue);
    border: none;
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .action-button:hover {
    background-color: var(--blue);
    color: white;
    transform: translateY(-2px);
  }

  .action-button svg {
    transition: transform 0.3s ease;
  }

  .action-button:hover svg {
    transform: rotate(5deg);
  }

  /* Password Form */
  .password-form-wrapper {
    background-color: rgba(0,0,0,0.02);
    border-radius: 12px;
    padding: 25px;
    border: 1px solid rgba(0,0,0,0.06);
    margin-top: 15px;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .form-fields {
    display: grid;
    gap: 20px;
  }

  .form-group {
    margin: 0;
  }

  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--dark);
    font-size: 14px;
  }

  .password-input-wrapper {
    position: relative;
  }

  .password-input-wrapper input {
    width: 100%;
    padding: 14px 16px;
    border: 1px solid rgba(0,0,0,0.15);
    border-radius: 8px;
    font-size: 16px;
    padding-right: 45px;
    transition: all 0.3s ease;
  }

  .password-input-wrapper input:focus {
    border-color: var(--blue);
    box-shadow: 0 0 0 3px rgba(var(--blue-rgb), 0.2);
    outline: none;
  }

  .toggle-password-visibility {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #777;
    cursor: pointer;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.3s ease;
  }

  .toggle-password-visibility:hover {
    color: var(--blue);
  }

  .password-strength-meter {
    margin-top: 10px;
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .strength-label {
    font-size: 12px;
    font-weight: 600;
    height: 15px;
  }

  .meter-bar {
    height: 5px;
    background-color: #eaeaea;
    border-radius: 3px;
    overflow: hidden;
  }

  .strength-value {
    display: block;
    height: 100%;
    width: 0;
    transition: width 0.3s ease, background-color 0.3s ease;
  }

  .form-actions {
    display: flex;
    gap: 12px;
    margin-top: 25px;
  }

  .primary-button, .secondary-button {
    padding: 12px 20px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    letter-spacing: 0.5px;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
  }

  .primary-button {
    background-color: var(--blue);
    color: white;
    flex: 1;
  }

  .secondary-button {
    background-color: transparent;
    color: var(--gray);
    border: 1px solid rgba(0,0,0,0.15);
  }

  .primary-button:hover {
    background-color: rgba(var(--blue-rgb), 0.9);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(var(--blue-rgb), 0.2);
  }

  .secondary-button:hover {
    background-color: rgba(0,0,0,0.05);
    border-color: rgba(0,0,0,0.25);
    transform: translateY(-2px);
  }

  /* Success message styling */
  .success-message {
    background-color: rgba(46, 204, 113, 0.1);
    border-left: 4px solid #2ecc71;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    animation: slideIn 0.5s ease;
  }

  @keyframes slideIn {
    from { transform: translateX(-20px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  .success-message p {
    color: #2ecc71;
    margin: 0;
    font-weight: 500;
    font-size: 14px;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .section-header {
      padding: 15px 20px;
    }

    .section-content {
      padding: 20px;
    }

    .info-item {
      flex-direction: column;
      align-items: flex-start;
      gap: 5px;
    }

    .info-value {
      text-align: left;
    }

    .form-actions {
      flex-direction: column;
    }

    .primary-button, .secondary-button {
      width: 100%;
    }
  }

  @media (max-width: 480px) {
    .section-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }

    .action-button {
      align-self: flex-start;
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Check for query parameter indicating successful update
    const urlParams = new URLSearchParams(window.location.search);

    // Contact info update message
    if (urlParams.get('contact-updated') === 'true') {
      // Show success message if not already displayed
      const contactSection = document.querySelector('.contact-section');
      if (contactSection && !contactSection.querySelector('.success-message')) {
        const successDiv = document.createElement('div');
        successDiv.className = 'success-message';
        successDiv.innerHTML = '<p>Your contact information has been updated successfully!</p>';
        contactSection.querySelector('.section-content').insertBefore(successDiv, contactSection.querySelector('.contact-info'));

        // Auto remove after 5 seconds
        setTimeout(() => {
          successDiv.classList.add('fade-out');
          setTimeout(() => {
            successDiv.remove();
            // Remove the query parameter
            const url = new URL(window.location);
            url.searchParams.delete('contact-updated');
            window.history.replaceState({}, '', url);
          }, 500);
        }, 5000);
      }
    }

    // Password update message
    if (urlParams.get('password-updated') === 'true') {
      const passwordSection = document.querySelector('.password-section');
      if (passwordSection && !passwordSection.querySelector('.success-message')) {
        const successDiv = document.createElement('div');
        successDiv.className = 'success-message';
        successDiv.innerHTML = '<p>Your password has been updated successfully!</p>';
        passwordSection.querySelector('.section-content').insertBefore(successDiv, passwordSection.querySelector('.password-form-wrapper'));

        // Auto remove after 5 seconds
        setTimeout(() => {
          successDiv.classList.add('fade-out');
          setTimeout(() => {
            successDiv.remove();
            // Remove the query parameter
            const url = new URL(window.location);
            url.searchParams.delete('password-updated');
            window.history.replaceState({}, '', url);
          }, 500);
        }, 5000);
      }
    }

    // Toggle password form visibility
    const toggleFormBtn = document.querySelector('.toggle-password-form');
    const passwordForm = document.querySelector('.password-form-wrapper');
    const cancelBtn = document.querySelector('.cancel-password-btn');

    if (toggleFormBtn && passwordForm) {
      toggleFormBtn.addEventListener('click', function() {
        if (passwordForm.style.display === 'none') {
          passwordForm.style.display = 'block';
          passwordForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
          passwordForm.style.display = 'none';
        }
      });

      if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
          passwordForm.style.display = 'none';
          // Clear form values
          const passwordInputs = passwordForm.querySelectorAll('input[type="password"]');
          passwordInputs.forEach(input => {
            input.value = '';
          });
          // Reset strength meter
          const strengthBar = passwordForm.querySelector('.strength-value');
          if (strengthBar) {
            strengthBar.style.width = '0%';
          }
          const strengthLabel = passwordForm.querySelector('.strength-label');
          if (strengthLabel) {
            strengthLabel.textContent = '';
          }
        });
      }
    }

    // Toggle password visibility
    const togglePasswordBtns = document.querySelectorAll('.toggle-password-visibility');

    togglePasswordBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        const passwordInput = this.parentElement.querySelector('input');
        const eyeIcon = this.querySelector('.eye-icon');
        const eyeOffIcon = this.querySelector('.eye-off-icon');

        if (passwordInput.type === 'password') {
          passwordInput.type = 'text';
          eyeIcon.style.display = 'none';
          eyeOffIcon.style.display = 'block';
        } else {
          passwordInput.type = 'password';
          eyeIcon.style.display = 'block';
          eyeOffIcon.style.display = 'none';
        }
      });
    });

    // Password strength meter
    const newPasswordInput = document.getElementById('CustomerNewPassword');
    const strengthBar = document.querySelector('.strength-value');
    const strengthLabel = document.querySelector('.strength-label');

    if (newPasswordInput && strengthBar && strengthLabel) {
      newPasswordInput.addEventListener('input', function() {
        const password = this.value;
        let strength = 0;
        let label = '';

        if (password.length >= 8) strength += 1;
        if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength += 1;
        if (password.match(/\d/)) strength += 1;
        if (password.match(/[^a-zA-Z\d]/)) strength += 1;

        switch (strength) {
          case 0:
            strengthBar.style.width = '0%';
            label = '';
            break;
          case 1:
            strengthBar.style.width = '25%';
            strengthBar.style.backgroundColor = '#ff4d4d'; // Red
            label = 'Weak';
            break;
          case 2:
            strengthBar.style.width = '50%';
            strengthBar.style.backgroundColor = '#ffa64d'; // Orange
            label = 'Fair';
            break;
          case 3:
            strengthBar.style.width = '75%';
            strengthBar.style.backgroundColor = '#99cc00'; // Light Green
            label = 'Good';
            break;
          case 4:
            strengthBar.style.width = '100%';
            strengthBar.style.backgroundColor = '#2ecc71'; // Green
            label = 'Strong';
            break;
        }

        strengthLabel.textContent = label;
        strengthLabel.style.color = strengthBar.style.backgroundColor;
      });

      // Password confirmation validation
      const confirmInput = document.getElementById('CustomerPasswordConfirmation');

      if (confirmInput) {
        confirmInput.addEventListener('input', function() {
          if (this.value !== newPasswordInput.value) {
            this.setCustomValidity('Passwords do not match');
          } else {
            this.setCustomValidity('');
          }
        });
      }
    }
  });
</script>