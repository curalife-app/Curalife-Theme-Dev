name: Lighthouse CI

on:
  schedule:
    - cron: "15 02 * * *" # Runs at 2:15 UTC daily
    - cron: "15 14 * * *" # Runs at 14:15 UTC daily
  workflow_dispatch:
    inputs:
      base_url:
        description: "Base URL to test"
        required: false
        default: "https://curalife.com"
      custom_pages:
        description: "Custom pages to test (JSON array of {name, url} objects)"
        required: false
        default: ""

# Allow one concurrent deployment
concurrency:
  group: "lighthouse-${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

permissions:
  contents: write

env:
  RESULTS_DIR: ${{ github.workspace }}/lighthouse-results
  BASE_URL: ${{ github.event.inputs.base_url || 'https://curalife.com' }}

jobs:
  lighthouse-tests:
    name: Run Lighthouse Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        device: [desktop, mobile]
        page:
          - name: homepage
            url: /
          - name: product
            url: /products/curalin
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup test environment
        uses: ./.github/actions/setup-environment
        with:
          node-version: "18"
          cache-dependencies: "true"

      - name: Setup results directory
        run: mkdir -p ${{ env.RESULTS_DIR }}/${{ matrix.device }}/${{ matrix.page.name }}

      - name: Run Lighthouse tests
        uses: ./.github/actions/run-lighthouse
        with:
          url: "${{ env.BASE_URL }}${{ matrix.page.url }}"
          test-name: "${{ matrix.page.name }}"
          output-dir: "${{ env.RESULTS_DIR }}/${{ matrix.device }}/${{ matrix.page.name }}"
          device: "${{ matrix.device }}"

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-${{ matrix.device }}-${{ matrix.page.name }}
          path: ${{ env.RESULTS_DIR }}/${{ matrix.device }}/${{ matrix.page.name }}
          retention-days: 7

  process-and-generate:
    name: Process Results & Generate Dashboard
    needs: [lighthouse-tests]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create results directory structure
        run: |
          mkdir -p ${{ env.RESULTS_DIR }}
          mkdir -p performance-reports

      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: ${{ env.RESULTS_DIR }}
          pattern: "lighthouse-*"
          merge-multiple: true

      - name: Reorganize directory structure
        run: |
          # Check downloads and fix structure if needed
          echo "Directory structure after downloading artifacts:"
          find ${{ env.RESULTS_DIR }} -maxdepth 3 -type d | sort

          # Create correct structure for devices/pages
          for device in desktop mobile; do
            mkdir -p ${{ env.RESULTS_DIR }}/$device

            # Move results to correct locations if needed
            find ${{ env.RESULTS_DIR }}/lighthouse-$device-* -maxdepth 0 -type d 2>/dev/null | while read -r dir; do
              page_name=$(basename "$dir" | sed "s/lighthouse-$device-//")
              mkdir -p ${{ env.RESULTS_DIR }}/$device/$page_name
              cp -r "$dir"/* ${{ env.RESULTS_DIR }}/$device/$page_name/ 2>/dev/null || echo "No files to copy from $dir"
            done
          done

          echo "Final directory structure:"
          find ${{ env.RESULTS_DIR }} -maxdepth 3 -type d | sort

      - name: Generate performance dashboard
        uses: ./.github/actions/generate-dashboard
        with:
          results-dir: ${{ env.RESULTS_DIR }}
          output-dir: ${{ env.RESULTS_DIR }}
          current-date: $(date +'%Y-%m-%d')
          templates-dir: .github/workflows/templates
          include-history: "true"

      - name: Upload dashboard artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-dashboard
          path: |
            ${{ env.RESULTS_DIR }}/dashboards/**
            ${{ env.RESULTS_DIR }}/processed/**
            ${{ env.RESULTS_DIR }}/index.html
            ${{ env.RESULTS_DIR }}/trends.html
            ${{ env.RESULTS_DIR }}/.nojekyll
            performance-reports/**
          retention-days: 7

  publish:
    name: Publish to GitHub Pages
    needs: [process-and-generate]
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download dashboard artifacts
        uses: actions/download-artifact@v4
        with:
          name: lighthouse-dashboard
          path: ./dashboard-output

      - name: Deploy to GitHub Pages
        uses: ./.github/actions/deploy-to-gh-pages
        with:
          source-dir: ./dashboard-output
          custom-domain: "speed.curalife.com"
          target-branch: "gh-pages"
          commit-message: "Update Lighthouse reports - $(date +'%Y-%m-%d %H:%M:%S')"
